## ğŸ“Œ INA226 é©±åŠ¨ä»£ç è§£æï¼ˆç»“æ„åŒ–æ³¨é‡Šç‰ˆï¼‰

------

[TOC]

------



### **1ï¸âƒ£ å¤´æ–‡ä»¶å®šä¹‰ (INA226.h)**

æ¸…æ™°åˆ’åˆ†å¯„å­˜å™¨å®šä¹‰ä¸æ•°æ®ç»“æ„

```c
#ifndef _INA226_H
#define _INA226_H

#include "gd32f4xx.h"
#include "Drv_i2c.h"

/*---------------------------------------
  I2C åœ°å€å®šä¹‰
---------------------------------------*/
#define WRITE_ADDR   0x80  // A0=GND, A1=GND çš„å†™åœ°å€
#define READ_ADDR    0x81  // è¯»åœ°å€

/*---------------------------------------
  å¯„å­˜å™¨åœ°å€å®šä¹‰
---------------------------------------*/
#define Config_Reg    0x00  // é…ç½®å¯„å­˜å™¨ï¼ˆè®¾ç½®é‡‡æ ·å‚æ•°ï¼‰
#define Shunt_V_Reg   0x01  // åˆ†æµç”µå‹å¯„å­˜å™¨ï¼ˆå•ä½ï¼š2.5uV/LSBï¼‰
#define Bus_V_Reg     0x02  // æ€»çº¿ç”µå‹å¯„å­˜å™¨ï¼ˆå•ä½ï¼š1.25mV/LSBï¼‰
#define Power_Reg     0x03  // åŠŸç‡å¯„å­˜å™¨ï¼ˆå•ä½ï¼š25*Current_LSBï¼‰
#define Current_Reg   0x04  // ç”µæµå¯„å­˜å™¨ï¼ˆå•ä½ï¼šç”¨æˆ·è‡ªå®šä¹‰LSBï¼‰
#define Calib_Reg     0x05  // æ ¡å‡†å¯„å­˜å™¨ï¼ˆå…³é”®è®¡ç®—å‚æ•°ï¼‰
#define ID_Reg        0xFF  // è®¾å¤‡IDå¯„å­˜å™¨ï¼ˆå›ºå®šå€¼0x2260ï¼‰

/*---------------------------------------
  æ•°æ®ç»“æ„å®šä¹‰
---------------------------------------*/
typedef struct {
    float ID;        // èŠ¯ç‰‡IDï¼ˆç”¨äºè®¾å¤‡æ£€æµ‹ï¼‰
    float Shunt_V;   // åˆ†æµç”µå‹ï¼ˆå•ä½ï¼šmVï¼‰
    float Curent;    // ç”µæµå€¼ï¼ˆå•ä½ï¼šmAï¼‰
    float Power;     // åŠŸç‡å€¼ï¼ˆå•ä½ï¼šmWï¼‰
} INA226_detection;

extern INA226_detection INA226_cnt;  // å…¨å±€æµ‹é‡æ•°æ®å­˜å‚¨

/*---------------------------------------
  å‡½æ•°å£°æ˜
---------------------------------------*/
uint16_t INA226_Read2Byte(uint8_t reg_addr);
uint8_t INA226_Write2Byte(uint8_t reg_addr, uint16_t reg_data);
void INA226_Init(void);
void INA226_GetValue(void);

#endif
```

---

### **2ï¸âƒ£ æ ¸å¿ƒå‡½æ•°å®ç° (INA226.c)**  
æ¨¡å—åŒ–ä»£ç æ®µ + é€è¡Œæ³¨é‡Š

```c
#include "INA226.h"
#include "systick.h"
#include "Drv_usart.h"
#include <stdio.h>
#include <stdlib.h>

INA226_detection INA226_cnt = {0};  // å…¨å±€æµ‹é‡æ•°æ®åˆå§‹åŒ–

/*=======================================
  I2C åŸºç¡€è¯»å†™æ“ä½œ
=======================================*/

/**
  * @brief  ä»æŒ‡å®šå¯„å­˜å™¨è¯»å–2å­—èŠ‚æ•°æ®
  * @param  reg_addr: å¯„å­˜å™¨åœ°å€ï¼ˆ0x00~0xFFï¼‰
  * @retval è¯»å–çš„16ä½æ•°æ®
  */
uint16_t INA226_Read2Byte(uint8_t reg_addr) {
    uint16_t reg_data = 0;
    
    // I2C è¯»æ“ä½œåè®®
    IIC_Start();
    IIC_Send_Byte(WRITE_ADDR);  // å‘é€å†™åœ°å€
    IIC_Wait_Ack();
    IIC_Send_Byte(reg_addr);    // å‘é€å¯„å­˜å™¨IC_Send_Byte(READ_ADDR);   // å‘é€è¯»åœ°å€
    IIC_Wait_Ack();
    
    // è¯»å–é«˜å­—èŠ‚ï¼ˆå‘é€ACKï¼‰
    reg_data = IIC_Read_Byte(1) << 8; 
    // è¯»å–ä½å­—èŠ‚ï¼ˆå‘é€NACKï¼‰
    reg_data |= IIC_Read_Byte(0); 
    
    IIC_Stop();
    return reg_data;
}

/**
  * @brief  å‘æŒ‡å®šå¯„å­˜å™¨å†™å…¥2å­—èŠ‚æ•°æ®
  * @param  reg_addr: å¯„å­˜å™¨åœ°å€
  * @param  reg_data: è¦å†™å…¥çš„16ä½æ•°æ®
  */
uint8_t INA226_Write2Byte(uint8_t reg_addr, uint16_t reg_data) {
    // æ‹†åˆ†é«˜ä½å­—èŠ‚
    uint8_t data_high = (reg_data >> 8) & 0xFF;
    uint8_t data_low  = reg_data & 0xFF;
    
    // I2C å†™æ“ä½œåè®®
    IIC_Start();
    IIC_Send_Byte(WRITE_ADDR);
    IIC_Wait_Ack();
    IIC_Send_Byte(reg_addr);
    IIC_Wait_Ack();
    IIC_Send_Byte(data_high);  // å†™å…¥é«˜å­—èŠ‚
    IIC_Wait_Ack();
    IIC_Send_Byte(data_low);   // å†™å…¥ä½å­—èŠ‚
    IIC_Wait_Ack();
    IIC_Stop();
    
    return 1; // æˆåŠŸæ ‡å¿—
}

/*=======================================
  è®¾å¤‡åˆå§‹åŒ–ä¸é…ç½®
=======================================*/

/**
  * @brief  INA226 åˆå§‹åŒ–é…ç½®
  * @note   é…ç½®é‡‡æ ·å‚æ•°ä¸æ ¡å‡†å€¼
  *         é…ç½®å¯„å­˜å™¨å€¼ 0x4527 åˆ†è§£ï¼š
  *         - å¹³å‡æ¬¡æ•°ï¼š16æ¬¡ï¼ˆbit9-11=010ï¼‰
  *         - æ€»çº¿ç”µå‹è½¬æ¢æ—¶é—´ï¼š1.1msï¼ˆbit6-8=100ï¼‰
  *         - åˆ†æµç”µå‹è½¬æ¢æ—¶é—´ï¼š1.1msï¼ˆbit3-5=100ï¼‰
  *         - å·¥ä½œæ¨¡å¼ï¼šè¿ç»­æµ‹é‡ï¼ˆbit0-2=111ï¼‰
  */
void INA226_Init(void) {
    IIC_Init();   // åˆå§‹åŒ–I2Cç¡¬ä»¶
    delay_ms(5);  // ç­‰å¾…å™¨ä»¶ä¸Šç”µç¨³å®š
    
    // é…ç½®é‡‡æ ·å‚æ•°ï¼ˆ0x4527ï¼‰
    INA226_Write2Byte(Config_Reg, 0x4527); 
    
    // è®¾ç½®æ ¡å‡†å€¼ï¼ˆåŸºäº0.02mA/LSBå’Œ0.1mÎ©åˆ†æµç”µé˜»ï¼‰
    // è®¡ç®—å…¬å¼ï¼šCal = 0.00512 / (Current_LSB * R_shunt)
    // æ­¤å¤„é¢„è®¾å€¼ 0x0A00 = 2560ï¼ˆåè¿›åˆ¶ï¼‰
    INA226_Write2Byte(Calib_Reg, 0x0A00); 
}

/*=======================================
  æ•°æ®è·å–ä¸å¤„ç†
=======================================*/

/**
  * @brief  è·å–å¹¶æ›´æ–°æ‰€æœ‰æµ‹é‡æ•°æ®
  * @note   åŸå§‹æ•°æ®ç›´æ¥å­˜å‚¨åˆ°å…¨å±€ç»“æ„ä½“ INA226_cnt
  */
void INA226_GetValue() {
    // è¯»å–è®¾å¤‡IDï¼ˆåº”ä¸º0x2260ï¼‰
    INA226_cnt.ID = INA226_Read2Byte(ID_Reg);
    
    // åˆ†æµç”µå‹ï¼ˆåŸå§‹å€¼ * 2.5uVï¼‰
    INA226_cnt.Shunt_V = INA226_Read2Byte(Shunt_V_Reg) * 0.0025f; 
    
    // ç”µæµå€¼ï¼ˆåŸå§‹å€¼ * 0.02mAï¼‰
    INA226_cnt.Curent = INA226_Read2Byte(Current_Reg) * 0.02f;  
    
    // åŠŸç‡å€¼ï¼ˆåŸå§‹å€¼ * 0.5mWï¼‰
    INA226_cnt.Power = INA226_Read2Byte(Power_Reg) * 0.5f;      
}
```

---

### **3ï¸âƒ£ å…³é”®å‚æ•°è¯´æ˜è¡¨**

| å‚æ•°            | å€¼      | è¯´æ˜                                                   |
| --------------- | ------- | ------------------------------------------------------ |
| **Shunt LSB**   | 2.5Î¼V   | åˆ†æµç”µå‹åˆ†è¾¨ç‡ï¼šå¯„å­˜å™¨å€¼1å¯¹åº”2.5å¾®ä¼                   |
| **Current LSB** | 0.02mA  | ç”µæµåˆ†è¾¨ç‡ï¼šæ ¹æ®æ ¡å‡†å€¼0x0A00è®¡ç®—å¾—å‡º                   |
| **Power LSB**   | 0.5mW   | åŠŸç‡åˆ†è¾¨ç‡ï¼šå›ºå®šä¸º25å€ç”µæµLSBï¼ˆ0.02mA * 25 = 0.5mWï¼‰   |
| **é‡‡æ ·æ—¶é—´**    | 1.1msÃ—2 | æ€»è½¬æ¢æ—¶é—´ = æ€»çº¿é‡‡æ ·æ—¶é—´ + åˆ†æµé‡‡æ ·æ—¶é—´ï¼ˆå…±2.2ms/æ¬¡ï¼‰ |
| **æ ¡å‡†å€¼å…¬å¼**  | 2560    | Cal = 0.00512 / (0.02mA * 0.0001Î©) = 2560              |

---

### **4ï¸âƒ£ å…¸å‹ä½¿ç”¨æµç¨‹**

```c
// åœ¨mainå‡½æ•°ä¸­çš„è°ƒç”¨ç¤ºä¾‹
int main() {
    // åˆå§‹åŒ–è®¾å¤‡
    INA226_Init();
    
    while(1) {
        // è·å–æœ€æ–°æ•°æ®
        INA226_GetValue();
        
        // æ‰“å°æµ‹é‡ç»“æœ
        printf("Shunt: %.2f mV, Current: %.2f mA, Power: %.2f mW\n", 
              INA226_cnt.Shunt_V, 
              INA226_cnt.Curent, 
              INA226_cnt.Power);
        
        delay_ms(1000);
    }
}
```

---

### **5ï¸âƒ£ è°ƒè¯•æŠ€å·§**

1. **IDå¯„å­˜å™¨éªŒè¯**  
   è¯»å–ID_Regï¼ˆ0xFFï¼‰ï¼Œæ­£ç¡®å€¼åº”ä¸º0x2260ï¼Œç”¨äºæ£€æµ‹ç¡¬ä»¶è¿æ¥æ˜¯å¦æ­£å¸¸ã€‚

2. **åŸå§‹æ•°æ®æ‰“å°**  
   åœ¨`INA226_GetValue()`ä¸­æ·»åŠ å¯„å­˜å™¨åŸå§‹å€¼æ‰“å°ï¼ŒéªŒè¯æ•°æ®æ˜¯å¦åœ¨åˆç†èŒƒå›´ï¼š
   ```c
   printf("Raw Shunt: 0x%04X, Raw Current: 0x%04X\n", 
         (uint16_t)INA226_cnt.Shunt_V, 
         (uint16_t)INA226_cnt.Curent);
   ```

3. **æ ¡å‡†å€¼éªŒè¯**  
   è‹¥æµ‹é‡ç”µæµä¸å‡†ç¡®ï¼Œæ£€æŸ¥æ ¡å‡†å€¼è®¡ç®—ï¼š  
   ```c
   float R_shunt = 0.0001; // å®é™…åˆ†æµç”µé˜»å€¼ï¼ˆÎ©ï¼‰
   uint16_t cal = 0.00512 / (0.02e-3 * R_shunt); // åº”ä¸º2560
   ```

---

é€šè¿‡ç»“æ„åŒ–æ³¨é‡Šä¸æ¨¡å—åŒ–ä»£ç ç»„ç»‡ï¼Œæ˜¾è‘—æå‡ä»£ç å¯ç»´æŠ¤æ€§ï¼ ğŸ› ï¸

# ğŸ› GD32 DAC0 é©±åŠ¨æ–‡æ¡£

[TOC]



## ğŸŒŸ æ¦‚è¿°

æœ¬é©±åŠ¨å®ç°GD32F4xxç³»åˆ—MCUçš„DAC0é€šé“1åŸºæœ¬åŠŸèƒ½ï¼Œæ”¯æŒï¼š
- 12ä½æ•°å­—é‡è½¬æ¨¡æ‹Ÿé‡è¾“å‡º
- è½¯ä»¶è§¦å‘æ¨¡å¼
- è¾“å‡ºç¼“å†²ä½¿èƒ½
- æ³¢å½¢ç”Ÿæˆç¦ç”¨æ¨¡å¼

## ğŸ“Œ ç¡¬ä»¶é…ç½®
| åŠŸèƒ½     | å¼•è„š | æ¨¡å¼     | è¯´æ˜         |
| -------- | ---- | -------- | ------------ |
| DAC_OUT1 | PA4  | æ¨¡æ‹Ÿè¾“å‡º | DACé€šé“1è¾“å‡º |

## ğŸ›  é©±åŠ¨å®ç°

### 1. åˆå§‹åŒ–å‡½æ•°
```c
void Drv_dac0_init() {
    dac0_init();  // å®é™…åˆå§‹åŒ–å‡½æ•°
}
```

### 2. æ ¸å¿ƒé…ç½®å‡½æ•°

```c
static void dac0_init() {
    // ä½¿èƒ½DACæ—¶é’Ÿ
    rcu_periph_clock_enable(RCU_DAC);
    
    // å¤ä½DAC0
    dac_deinit(DAC0); 
    
    // é…ç½®è§¦å‘æ¨¡å¼
    dac_trigger_disable(DAC0, DAC_OUT1);  // ç¦ç”¨ç¡¬ä»¶è§¦å‘
    
    // æ³¢å½¢ç”Ÿæˆé…ç½®
    dac_wave_mode_config(DAC0, DAC_OUT1, DAC_WAVE_DISABLE);  // ç¦ç”¨æ³¢å½¢ç”Ÿæˆ
    
    // è¾“å‡ºç¼“å†²é…ç½®
    dac_output_buffer_enable(DAC0, DAC_OUT1);  // ä½¿èƒ½è¾“å‡ºç¼“å†²
    
    // å¯ç”¨DACé€šé“
    dac_enable(DAC0, DAC_OUT1);  
}
```

## ğŸ“Š å…³é”®é…ç½®è¯´æ˜

### è§¦å‘æ¨¡å¼é€‰æ‹©

| æ¨¡å¼         | APIå‡½æ•°                 | è¯´æ˜                   |
| :----------- | :---------------------- | :--------------------- |
| è½¯ä»¶è§¦å‘     | `dac_trigger_disable()` | ç›´æ¥å†™å…¥æ•°æ®å¯„å­˜å™¨ç”Ÿæ•ˆ |
| å®šæ—¶å™¨è§¦å‘   | `dac_trigger_enable()`  | éœ€é…ç½®å¯¹åº”å®šæ—¶å™¨       |
| å¤–éƒ¨äº‹ä»¶è§¦å‘ | `dac_trigger_enable()`  | éœ€é…ç½®EXTI             |

### æ³¢å½¢ç”Ÿæˆæ¨¡å¼

| æ¨¡å¼     | APIå‡½æ•°                  | è¯´æ˜               |
| :------- | :----------------------- | :----------------- |
| ç¦ç”¨æ³¢å½¢ | `DAC_WAVE_DISABLE`       | ç›´æ¥è¾“å‡ºè®¾å®šå€¼     |
| å™ªå£°æ³¢å½¢ | `DAC_WAVE_MODE_LFSR`     | ä¼ªéšæœºå™ªå£°è¾“å‡º     |
| ä¸‰è§’æ³¢   | `DAC_WAVE_MODE_TRIANGLE` | å¯é…ç½®å¹…åº¦çš„ä¸‰è§’æ³¢ |

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”µå‹è¾“å‡º

```c
// åˆå§‹åŒ–DAC
Drv_dac0_init();

// è®¾ç½®è¾“å‡ºç”µå‹(0-4095å¯¹åº”0-3.3V)
dac_data_set(DAC0, DAC_OUT1, DAC_ALIGN_12B_R, 2048);  // è¾“å‡º1.65V
```

### åŠ¨æ€ç”µå‹è°ƒæ•´

```c
void SetVoltage(float voltage) {
    if(voltage > 3.3f) voltage = 3.3f;
    if(voltage < 0.0f) voltage = 0.0f;
    
    uint16_t dac_value = (uint16_t)(voltage * 4095 / 3.3f);
    dac_data_set(DAC0, DAC_OUT1, DAC_ALIGN_12B_R, dac_value);
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è¾“å‡ºç¼“å†²ç‰¹æ€§**

   - ä½¿èƒ½ç¼“å†²ï¼šæé«˜é©±åŠ¨èƒ½åŠ›ä½†å¢åŠ å»ºç«‹æ—¶é—´
   - ç¦ç”¨ç¼“å†²ï¼šå“åº”æ›´å¿«ä½†é©±åŠ¨èƒ½åŠ›å¼±

2. **ç²¾åº¦å½±å“è¦ç´ **

   ```math
   å®é™…ç”µå‹ = \frac{V_{REF} \times DAC_{CODE}}{4095}
   ```

   - å‚è€ƒç”µå‹ç¨³å®šæ€§ç›´æ¥å½±å“è¾“å‡ºç²¾åº¦

3. **å»ºç«‹æ—¶é—´**

   | æ¡ä»¶     | å…¸å‹å»ºç«‹æ—¶é—´ |
   | :------- | :----------- |
   | ç¼“å†²ä½¿èƒ½ | 3Î¼s          |
   | ç¼“å†²ç¦ç”¨ | 1Î¼s          |

4. **å¼•è„šé…ç½®**

   - å¿…é¡»é…ç½®ä¸ºæ¨¡æ‹Ÿæ¨¡å¼
   - é¿å…ä¸æ•°å­—åŠŸèƒ½å†²çª

## ğŸ” è°ƒè¯•æŠ€å·§

### å¸¸è§é—®é¢˜æ’æŸ¥

| ç°è±¡         | å¯èƒ½åŸå›             | è§£å†³æ–¹æ¡ˆ             |
| :----------- | :------------------ | :------------------- |
| æ— è¾“å‡º       | å¼•è„šæ¨¡å¼é…ç½®é”™è¯¯    | æ£€æŸ¥GPIOæ¨¡æ‹Ÿæ¨¡å¼é…ç½® |
| è¾“å‡ºå¹…åº¦ä¸è¶³ | ç¼“å†²æœªä½¿èƒ½          | å¯ç”¨è¾“å‡ºç¼“å†²         |
| è¾“å‡ºå™ªå£°å¤§   | ç”µæºå™ªå£°            | å¢åŠ æ»¤æ³¢ç”µå®¹         |
| å“åº”å»¶è¿Ÿ     | ç¼“å†²ä½¿èƒ½+å¤§å®¹æ€§è´Ÿè½½ | ç¦ç”¨ç¼“å†²æˆ–å‡å°è´Ÿè½½   |

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. åŠ¨æ€åˆ‡æ¢ç¼“å†²æ¨¡å¼ï¼š

   ```c
   void SetHighSpeedMode(bool enable) {
       enable ? dac_output_buffer_disable(DAC0, DAC_OUT1)
              : dac_output_buffer_enable(DAC0, DAC_OUT1);
   }
   ```

2. æ ¡å‡†è¾“å‡ºç²¾åº¦ï¼š

   ```c
   // ä½¿ç”¨é«˜ç²¾åº¦ä¸‡ç”¨è¡¨æµ‹é‡å®é™…ç”µå‹
   void CalibrateDAC() {
       float measured, error;
       // ...æ ¡å‡†æµç¨‹...
   }
   ```

## ğŸ“ˆ æ€§èƒ½å‚æ•°

| å‚æ•°         | æ•°å€¼            |
| :----------- | :-------------- |
| åˆ†è¾¨ç‡       | 12ä½            |
| çº¿æ€§è¯¯å·®     | Â±1LSB           |
| è¾“å‡ºé˜»æŠ—     | 50Î© (ç¼“å†²ä½¿èƒ½)  |
| å»ºç«‹æ—¶é—´     | 3Î¼s (ç¼“å†²ä½¿èƒ½)  |
| æœ€å¤§æ›´æ–°é€Ÿç‡ | 1MHz (è½¯ä»¶è§¦å‘) |

## ğŸ”„ æ‰©å±•åŠŸèƒ½

å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å¢å¼ºé©±åŠ¨ï¼š

1. æ·»åŠ DMAæ”¯æŒè¿ç»­æ³¢å½¢è¾“å‡º
2. å®ç°è‡ªåŠ¨æ ¡å‡†åŠŸèƒ½
3. å¢åŠ ç¡¬ä»¶è§¦å‘é…ç½®æ¥å£
4. æ·»åŠ å¤šé€šé“åŒæ­¥æ”¯æŒ

## ğŸ“–å®Œæ•´ä»£ç 

### dac.c

```c
#include "Drv_dac0.h"

static void dac0_init();

//DAC åŠŸèƒ½åˆå§‹åŒ–
void Drv_dac0_init()
{
	dac0_init();
}

// DAC0åˆå§‹åŒ–
static void dac0_init()
{
    rcu_periph_clock_enable(RCU_DAC);
	dac_deinit(DAC0); 
	dac_trigger_disable(DAC0, DAC_OUT1);  
	dac_wave_mode_config(DAC0, DAC_OUT1, DAC_WAVE_DISABLE);  
	dac_output_buffer_enable(DAC0, DAC_OUT1);  
	dac_enable(DAC0, DAC_OUT1);  
}
```

### dac.h

```c
#ifndef DRV_DAC0_H
#define DRV_DAC0_H

#include "gd32f4xx.h"
#include "Drv_usart0.h"

void Drv_dac0_init();

#endif 
```


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çƒæ¸¸æˆ - è¿›è¢‹æµ‹è¯•ç‰ˆ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .pocket-debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-width: 250px;
            z-index: 1000;
        }
        .pocket-debug h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        .pocket-log {
            background: rgba(0,100,0,0.2);
            border: 1px solid #66ff66;
            color: #ccffcc;
            margin-top: 10px;
            padding: 5px;
            border-radius: 3px;
            max-height: 150px;
            overflow-y: auto;
        }
        .ball-status {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            font-size: 11px;
        }
        .ball-status.active {
            color: #FFD700;
        }
        .ball-status.potted {
            color: #ff6666;
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div class="pocket-debug" id="pocketDebug">
        <h3>ğŸ•³ï¸ è¿›è¢‹æµ‹è¯•é¢æ¿</h3>
        <div>çƒæ€»æ•°: <span id="totalBalls">16</span></div>
        <div>å‰©ä½™çƒ: <span id="remainingBalls">16</span></div>
        <div>å·²è¿›çƒ: <span id="pottedBalls">0</span></div>
        <div style="margin-top: 10px; font-size: 11px;">
            <div>çƒçŠ¶æ€:</div>
            <div id="ballStatus"></div>
        </div>
        <div class="pocket-log" id="pocketLog">
            <div style="font-weight: bold; color: #66ff66;">è¿›è¢‹æ—¥å¿—:</div>
            <div id="pocketMessages">ç­‰å¾…è¿›è¢‹...</div>
        </div>
    </div>

    <div class="game-container">
        <h1>å°çƒæ¸¸æˆ - è¿›è¢‹æµ‹è¯•ç‰ˆ</h1>
        <canvas id="gameCanvas" width="1600" height="700"></canvas>
        <div class="controls">
            <div class="power-label">åŠ›åº¦:</div>
            <div class="power-bar">
                <div class="power-fill" id="powerFill"></div>
            </div>
            <button class="restart-btn" onclick="if(window.game) game.restart()">é‡æ–°å¼€å§‹</button>
            <div class="status">
                <div>å·²è¿›çƒ: <span id="pottedBallsMain">æ— </span></div>
                <div>FPS: <span id="fpsDisplay">--</span></div>
                <label class="debug-label"><input type="checkbox" id="debugToggle" checked> è°ƒè¯•ä¿¡æ¯</label>
            </div>
            <div class="instructions">
                <strong>è¿›è¢‹æµ‹è¯•ç‰ˆæœ¬</strong><br>
                å°è¯•å‡»çƒè¿›è¢‹ï¼Œè§‚å¯Ÿå·¦ä¾§é¢æ¿çš„æ—¥å¿—<br>
                å¦‚æœå‡ºç°å¡æ­»ï¼Œæ—¥å¿—ä¼šåœæ­¢æ›´æ–°
            </div>
        </div>
    </div>

    <script type="module">
        const pocketMessages = [];
        let originalBallCount = 16;

        function addPocketLog(message) {
            pocketMessages.push(new Date().toLocaleTimeString() + ': ' + message);
            document.getElementById('pocketMessages').innerHTML = pocketMessages.slice(-10).join('<br>');
        }

        function updateBallStatus() {
            if (window.game && window.game.balls) {
                const remaining = window.game.balls.length;
                const potted = originalBallCount - remaining;

                document.getElementById('totalBalls').textContent = originalBallCount;
                document.getElementById('remainingBalls').textContent = remaining;
                document.getElementById('pottedBalls').textContent = potted;

                // æ˜¾ç¤ºçƒçŠ¶æ€
                const statusDiv = document.getElementById('ballStatus');
                let statusHTML = '';

                // æ˜¾ç¤ºå‰©ä½™çš„çƒ
                window.game.balls.forEach(ball => {
                    const isMoving = Math.abs(ball.vx) > 0.01 || Math.abs(ball.vy) > 0.01;
                    const className = isMoving ? 'active' : '';
                    const ballName = ball.number === null ? 'ç™½çƒ' : ball.number + 'å·';
                    statusHTML += `<div class="ball-status ${className}">${ballName}: åœ¨æ¡Œ</div>`;
                });

                // æ˜¾ç¤ºå·²è¿›è¢‹çš„çƒ
                if (window.game.potted) {
                    window.game.potted.forEach(num => {
                        statusHTML += `<div class="ball-status potted">${num}å·: è¿›è¢‹</div>`;
                    });
                }

                statusDiv.innerHTML = statusHTML;
            }
        }

        // æ‹¦æˆªè¿›è¢‹äº‹ä»¶
        function interceptPocketEvents() {
            if (window.game && window.game.physics) {
                const originalCheckPockets = window.game.physics.checkPockets;
                window.game.physics.checkPockets = function(balls, pockets, cueBall, tableConfig, callbacks) {
                    // è®°å½•è°ƒç”¨
                    addPocketLog('æ£€æŸ¥è¿›è¢‹: ' + balls.length + ' ä¸ªçƒ');

                    // å¢å¼ºå›è°ƒ
                    const enhancedCallbacks = {
                        onCueBallPocketed: () => {
                            addPocketLog('ğŸ± ç™½çƒè¿›è¢‹ï¼');
                            if (callbacks.onCueBallPocketed) callbacks.onCueBallPocketed();
                        },
                        onBallPocketed: (ball) => {
                            addPocketLog(`âš« ${ball.number}å·çƒè¿›è¢‹ï¼`);
                            if (callbacks.onBallPocketed) callbacks.onBallPocketed(ball);
                        }
                    };

                    try {
                        return originalCheckPockets.call(this, balls, pockets, cueBall, tableConfig, enhancedCallbacks);
                    } catch (error) {
                        addPocketLog('âŒ è¿›è¢‹æ£€æµ‹é”™è¯¯: ' + error.message);
                        console.error('è¿›è¢‹æ£€æµ‹é”™è¯¯:', error);
                    }
                };
            }
        }

        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(updateBallStatus, 200);

        try {
            // åŠ è½½æ¸¸æˆ
            await import('./game.js');
            addPocketLog('âœ… æ¸¸æˆåŠ è½½æˆåŠŸ');

            // ç­‰å¾…ä¸€ç‚¹æ—¶é—´è®©æ¸¸æˆåˆå§‹åŒ–
            setTimeout(() => {
                interceptPocketEvents();
                addPocketLog('ğŸ”§ è¿›è¢‹ç›‘æ§å·²å¯åŠ¨');
            }, 1000);

        } catch (error) {
            addPocketLog('âŒ æ¸¸æˆåŠ è½½å¤±è´¥: ' + error.message);
            console.error('æ¸¸æˆåŠ è½½å¤±è´¥:', error);
        }
    </script>
</body>
</html>
